---
title: "ã€ç¤¾å†…å‹‰å¼·ä¼šè³‡æ–™ã€‘Reactâ‘¢ å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ã¤ã„ã¦"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["React" ,"useMemo","useCallback"]
published: false
---

ã“ã®è¨˜äº‹ã¯ç¤¾å†…å‹‰å¼·ä¼šã®ãŸã‚ã«ä½œæˆã—ã¾ã—ãŸã€‚
ä¸»ã« React ã®åŸºæœ¬+Î±ã®å†…å®¹ã«ã¤ã„ã¦ã€è‡ªåˆ†ã®**è¶…ä¸»è¦³çš„**ãªç†è§£ã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

:::message
ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Šå†…å®¹ã¯**è‡ªåˆ†ã®æ¨æ¸¬**ã«ãªã‚Šã¾ã™ã€‚  
é–“é•ã£ã¦ã‚‹ã“ã¨ç­‰ã‚ã‚‹ã¨æ€ã†ã®ã§ã€æŒ‡æ‘˜ã‚„è£œè¶³ç­‰ã‚ã‚Šã¾ã—ãŸã‚‰ã‚„ã•ã—ãæ•™ãˆã¦ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
:::

- ç¬¬ 1 å› ... Type ã‹ã‚‰æ¨æ¸¬ã™ã‚‹ JSX ã®åŸºæœ¬
- ç¬¬ 2 å› ... useState ã¨ useEffect ã®ä¸­èº«
- ç¬¬ 3 å› ... å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ã¤ã„ã¦ï¼ˆã“ã®è¨˜äº‹ï¼‰
- æœªå®š ... useRef/useReducer ã«ã¤ã„ã¦
- æœªå®š ... ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬æ–¹æ³•

## ä»Šå›ã®ä¼šã§è©±ã™å†…å®¹
- React ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- React ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’æŠ‘åˆ¶ã™ã‚‹æ–¹æ³•
- `React.memo`, `useMemo`, `useCallback` ã«ã¤ã„ã¦

æœ¬ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹è¨˜äº‹ã®å†…å®¹ã‚’å¤§ã„ã«è¸è¥²ã—ã¦ã¾ã™ã€‚

https://qiita.com/seira/items/9e38204758030cd5442a

## åˆæœŸæ•´å‚™

Chrome ã® React-dev-tools æ‹¡å¼µæ©Ÿèƒ½ã‹ã‚‰ã€Profiler å†…ã® `Highlight~` ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãŠãã¨å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯¾è±¡ãŒåˆ†ã‹ã‚Šã‚„ã™ããªã£ãŸã‚Šã—ã¾ã™ã€‚  
[![Image from Gyazo](https://i.gyazo.com/4be8c4c491842f42971db9d34eb135c3.png)](https://gyazo.com/4be8c4c491842f42971db9d34eb135c3)


ã¨ã‚Šã‚ãˆãš React ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚
ä»Šå›ã¯[Vite](https://vitejs.dev/)ã§ã€‚
https://vite.new/react ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã™ãå§‹ã‚ã‚‰ã‚ŒãŸã‚Šã—ã¾ã™ã€‚

â€»æœ€çµ‚ç‰ˆã¯ã“ã¡ã‚‰ã€‚

@[codesandbox](https://codesandbox.io/embed/react-re-render-m9943?fontsize=14&hidenavigation=1&theme=dark)

`src/App.jsx` ã«ã¦ã‚«ã‚¦ãƒ³ã‚¿ãŒã§ãã¦ã‚‹ãŒãƒœã‚¿ãƒ³ä»¥å¤–ã¯ä¸è¦ãªã®ã§æ¶ˆã—ã¾ã™ã€‚
ä»£ã‚ã‚Šã«ãƒ­ã‚°å‡ºåŠ›ã‚’è¶³ã—ã¾ã™ã€‚

```jsx:App.jsx
import {useState} from 'react'
import './App.css'

function App() {
  const [count, setCount] = useState(0)
  console.log('App') // è¶³ã™

  return (
    <button type="button" onClick={() => setCount((count) => count + 1)}>
      count is: {count}
    </button>
  )
}

export default App
```


ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã‚Šãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒ­ã‚°ã« `App` ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã—ãŸã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼ˆã ã„ãŸã„ï¼‰ã€‚

é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§æç”»ã‚’æ›´æ–°ã—ã¦ã„ã‚‹ã¨è¨€ãˆã‚‹ã§ã—ã‚‡ã†ã€‚

## Reactã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ã¯

https://qiita.com/hellokenta/items/6b795501a0a8921bb6b5

> ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ã¯ã€ç¾åœ¨ã®Propsã¨Stateã‚’å…ƒã«ã€ReactãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¯¾ã—ã¦ã€ãã‚Œã‚‰ãŒã©ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã¹ããªã®ã‹ã‚’å°‹ã­ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚

> ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ„ãƒªãƒ¼å…¨ä½“ã‹ã‚‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡ºåŠ›ã‚’åé›†ã—ãŸå¾Œã€React ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ–°ã—ã„ãƒ„ãƒªãƒ¼ï¼ˆã€Œä»®æƒ³ DOMã€ã¨å‘¼ã°ã‚Œã‚‹ã“ã¨ãŒå¤šã„ï¼‰ã®å·®åˆ†è¨ˆç®—ã‚’ã—ã€å®Ÿéš›ã®å¤‰æ›´ã™ã¹ãDOMã®ãƒªã‚¹ãƒˆã‚’åé›†ã—ã¾ã™ã€‚ã“ã®å·®åˆ†ã¨è¨ˆç®—ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€"reconcilation"ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

ã¤ã¾ã‚Šã€React ã¯ JSX ã‚’å…ƒã«ä»®æƒ³ DOM ã¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ„ãƒªãƒ¼ã‚’å½¢æˆã—ã€ãã®ä¸­ã§å¤‰æ›´ã™ã¹ãã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç®—å‡ºã—ã¦å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ï¼ˆæ›–æ˜§ãªç†è§£ï¼‰ã€‚

ã§ã¯ä½•ã‚’ã‚‚ã£ã¦å¤‰æ›´ã™ã¹ãã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¦ã„ã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚


## ãƒœã‚¿ãƒ³ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã™ã‚‹
`src/Counter.jsx` ã‚’ä½œã‚Šã¾ã™ã€‚

```jsx:Counter.jsx
const Counter = ({name, count, onClick}) => {
  console.log('Counter' + name)

  return (
    <button type="button" onClick={onClick}>
      Counter{name}: {count}
    </button>
  )
}
export default Counter
```

`App.tsx` ã‹ã‚‰ 3 ã¤å‘¼ã³å‡ºã—ã¾ã™ã€‚

```jsx:App.tsx
import {useState} from 'react'
import './App.css'
import Counter from "./Counter"

function App() {
  const [countA, setCountA] = useState(0)
  const [countB, setCountB] = useState(0)
  const [countC, setCountC] = useState(0)
  console.log('App')

  const incrementA = () => setCountA(prev => prev + 1)
  const incrementB = () => setCountB(prev => prev + 1)
  const incrementC = () => setCountC(prev => prev + 1)

  return (
    <div>
      <Counter name={'A'} count={countA} onClick={incrementA}/>
      <Counter name={'B'} count={countB} onClick={incrementB}/>
      <Counter name={'C'} count={countC} onClick={incrementC}/>
    </div>
  )
}

export default App
```

ã“ã®ã¨ãã« Counter ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã©ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚

:::details çµæœã‚’è¦‹ã‚‹
å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã€‚
:::


### ãªãœã“ã†ãªã‚‹ã®ã‹
React ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹ã®ã¯ã€

- props ãŒæ›´æ–°ã•ã‚ŒãŸã¨ã
- state ãŒæ›´æ–°ã•ã‚ŒãŸã¨ã

ã®ã„ãšã‚Œã‹ã§ã™ã€‚

https://ja.reactjs.org/docs/optimizing-performance.html#avoid-reconciliation
>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® props ã‚„ state ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€React ã¯æ–°ã—ãè¿”ã•ã‚ŒãŸè¦ç´ ã¨ä»¥å‰ã«ãƒ¬ãƒ³ãƒ€ãƒ¼ã•ã‚ŒãŸã‚‚ã®ã¨ã‚’æ¯”è¼ƒã™ã‚‹ã“ã¨ã§ã€å®Ÿéš›ã® DOM ã®æ›´æ–°ãŒå¿…è¦ã‹ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚ãã‚Œã‚‰ãŒç­‰ã—ããªã„å ´åˆã€React ã¯ DOM ã‚’æ›´æ–°ã—ã¾ã™ã€‚

ãã—ã¦ã€ãã‚ŒãŒç™ºç”Ÿã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ï¼ˆåŸºæœ¬çš„ã«ï¼‰å…¨ã¦å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚


â†‘ã®ä¾‹ã§ã¯ã€

1. `Counter` ã® onClick ã§ `App.jsx` ã® state ãŒæ›´æ–°ã•ã‚Œã‚‹
1. `App.jsx` ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
1. `App.jsx` ã®å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚ã‚‹å…¨ã¦ã® `Counter` ã‚‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹

ã¨ã„ã†å…·åˆã«ãªã‚Šã¾ã™ã€‚

## å•é¡Œã¯ãªã„ãŒ
ç‰¹ã«ä»Šå›ã®ã‚ˆã†ãªè»½é‡ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«å¯¾ã—ã¦ã‚³ã‚¹ãƒˆãŒã‹ã‹ã£ã¦ãªã„ã®ã§ä½•ã‚‚æ°—ã«ã™ã‚‹ã“ã¨ã¯ãªã„ã§ã™ã€‚ï¼ˆâ†ã“ã‚Œã¯çµæ§‹å¤§äº‹ã ã£ãŸã‚Šã™ã‚‹ï¼‰

## CounterCã‚’é‡ãã™ã‚‹
é–¢æ•°å†…ã§ `heavyCalc` ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é€Ÿåº¦ã‚’ä¸‹ã’ã¦ã¿ã¾ã™ã€‚

```jsx:App.jsx
import {useState} from 'react'
import './App.css'
import Counter from "./Counter"

// è¿½åŠ 
const heavyCalc = () => {
  let i = 0
  while (i < 1000000) {
    i++
    let j = 0
    while (j < 1000) {
      j++
    }
  }

  return i
}

function App() {
  const [countA, setCountA] = useState(0)
  const [countB, setCountB] = useState(0)
  const [countC, setCountC] = useState(0)
  console.log('App')

  const incrementA = () => setCountA(prev => prev + 1)
  const incrementB = () => setCountB(prev => prev + 1)
  const incrementC = () => setCountC(prev => prev + 1)

  // è¿½åŠ 
  const bigNumber = heavyCalc(countC)

  return (
    <div>
      <Counter name={'A'} count={countA} onClick={incrementA}/>
      <Counter name={'B'} count={countB} onClick={incrementB}/>
      <Counter name={'C'} count={bigNumber + countC} onClick={incrementC}/>
    </div>
  )
}

export default App
```

ã©ã¡ã‚‰ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚åæ˜ ã¾ã§ã¡ã‚‡ã£ã¨å¾…ã¤æ„Ÿã˜ã«ãªã‚Œã° OKã€‚

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã¸ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
ã“ã†ãªã£ã¦ãã‚‹ã¨å‡¦ç†ã‚’æ—©ãã—ãŸã„ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ²¸ã„ã¦ãã¾ã—ãŸã­ï¼

ãã“ã§ã“ã® App ã«å¯¾ã—ã¦ã©ã†ã„ã†ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ãŒã§ãã‚‹ã‹è€ƒãˆã¦ã¿ã¾ã™ã€‚

## â‘ `heavyCalc` ã¯æ¯åº¦è¨ˆç®—ã—ãªãã¦ã„ã„ã¯ãš
`ButtonWithState` ã‚’ã‚ˆãè¦‹ã¦ã¿ã‚‹ã¨ `heavyCalc` ã‚’å®Ÿè¡Œã™ã‚‹ã®ã¯ 1 åº¦ã ã‘ã§ã„ã„ã¯ãšã§ã™ã€‚
log ã¨åŒæ™‚ã«èµ°ã£ã¦ã‚‹ã¯ãšãªã®ã§ state ã‚’æ›´æ–°ã™ã‚‹åº¦ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹æ§˜å­ã€‚

ãã®çµæœã€ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã«æ¯åº¦ã¡ã‚‡ã£ã¨ãƒ©ã‚°ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

ç‰¹å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã ã‘å†è¨ˆç®—ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã„ã¨ãã«ä½¿ãˆã‚‹ã®ãŒ `useMemo` ã§ã™ã€‚

```diff:ButtonWithState.jsx
-  const bigNumber = heavyCalc(countC)
+  const bigNumber = useMemo(() => heavyCalc(countC), []);
```

ç¬¬äºŒå¼•æ•°ã® deps ã«ç©ºé…åˆ—ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§åˆå›ã®ã¿å‡¦ç†ãŒèµ°ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
â€»deps ã«ã¤ã„ã¦ã¯ useEffect å›ã‚’å‚ç…§ã€‚

ä»Šå›ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚ã‚Œã°ã“ã‚Œã ã‘ã§ã»ã¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã¯ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚
ãŒã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’è¦‹ã‚‹ã¨æ¯åº¦å…¨ã¦ã® Counter ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚‚åˆ¶å¾¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## â‘¡`CounterA/B` ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã¯ `CounterC` ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯ã•ã‚Œãªãã¦ã‚‚ã„ã„ã¯ãš
è©°ã¾ã‚‹ã¨ã“ã‚ã€è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã‚‚å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„æ–¹æ³•ã¨ã„ã†ã“ã¨ã§ã™ã€‚

ä»Šå›ã®ä¾‹ã§ã„ã†ã¨ã€App ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® state ãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«ã€å½±éŸ¿ã®ãªã„ Counter ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚

### 2-1 stateã‚’å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ç§»å‹•ã™ã‚‹
æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªè§£æ±ºç­–ã¯ state ã‚’ãªã‚‹ã¹ãæœ«ç«¯ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ç§»å‹•ã™ã‚‹ã“ã¨ã§ã—ã‚‡ã†ã€‚
å¤§ä½“ã®ã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã€ã¾ãšã¯ã“ã‚Œã‚’æ¤œè¨ã™ã‚‹ã®ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã®ä¾‹ã§ã¯ä¾‹ãˆã° B ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’åˆ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã—ã¦ãã£ã¡ã« state ã‚’ã‚‚ãŸã›ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

```jsx:CounterB.jsx
import {useState} from "react"
import Counter from "./Counter"

const CounterB = () => {
  const [countB, setCountB] = useState(0)

  const incrementB = () => setCountB(prev => prev + 1)

  return <Counter name={'B'} count={countB} onClick={incrementB}/>
}

export default CounterB
```

```diff:App.jsx
- <Counter name={'B'} count={countB} onClick={incrementB}/>
+ <CounterB />
```

ã“ã†ã™ã‚‹ã“ã¨ã§ CounterB ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«æ›´æ–°ã•ã‚Œã‚‹ state ã¯ `App`â†’`CounterB` ã«å¤‰ã‚ã‚Šã¾ã™ã€‚
ãã®ãŸã‚ã€CounterB ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« `App` ã‚„ä»–ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œãªããªã‚Šã¾ã™ã€‚

ã—ã‹ã—ã€CounterA/C ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã¯å…¨ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚

### 2-2 `React.memo`
æ¬¡ã«ãƒ¡ãƒ¢åŒ–ã«ã¤ã„ã¦ã€‚

React.memo ã‚’ä½¿ã†ã“ã¨ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã„ã¤å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¹ããªã®ã‹ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

::: message
ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã„ã†ã¨ `shouldComponentUpdate` ã‚„ `PureComponent` ã¨é–¢ä¿‚ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‹ã‚‰ä½¿ã†ã“ã¨ã¯ã»ã¼ç„¡ã„ã¨æ€ã„ã¾ã™ãŒã€èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯èª¿ã¹ã¦ã¿ã¦ãã ã•ã„ã€‚
:::

React.memo ã«ã¯çœç•¥å¯èƒ½ãªç¬¬äºŒå¼•æ•°ãŒã‚ã‚Šã¾ã™ã€‚
ãã“ã§ã¯ã€props ã®æ–°æ—§å€¤ã‚’æ¯”è¼ƒã—ã¦ã€ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¹ãã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚
ï¼ˆâ€»æœªæŒ‡å®šã®ã¨ãã¯è‡ªå‹•çš„ã« props ãŒç­‰ã—ã„ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã•ã‚Œã‚‹ã€‚ï¼‰

:::message
ã“ã®ã¨ãã« props ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã¨ React ã¯æµ…ã„æ¯”è¼ƒã‚’ã™ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€props ãŒç­‰ã—ã„ã‹ã©ã†ã‹ãŒæ­£ç¢ºã«åˆ¤æ–­ã•ã‚Œãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
props ã«ã¯æ¥µåŠ›ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã‚’ä½¿ã†ã®ãŒã‚·ãƒ³ãƒ—ãƒ«ã§ã„ã„ã§ã—ã‚‡ã†ã€‚
â€»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã®å¯¾ç­–ã¯æœ€å¾Œã«ã€‚
:::

ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ props ãŒãªã„ã®ã‚‚ã‚ã£ã¦ã€çœç•¥ã§ã‚ˆã•ãã†ã§ã™ã€‚

export default ã—ã¦ã„ã‚‹ç®‡æ‰€ã«è¨˜è¿°ã™ã‚‹ã®ãŒæ¥½ã§ã™ã­ã€‚

```diff:Counter.jsx
- export default Counter
+ export default memo(Counter)
```

```diff:CounterB.jsx
- export default CounterB
+ export default memo(CounterB)
```

ã“ã‚Œã§ OK ã«ãªã‚Šãã†ã§ã™ãŒã€å®Ÿéš›ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒæŠ‘æ­¢ã•ã‚ŒãŸã®ã¯ CounterB ã®ã¿ã€‚
ã“ã®é•ã„ã¯ä½•ã‹ã‚‰ç™ºç”Ÿã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã€‚

### 2-3 `useCallback`
Counter ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã»ã†ã¯ props ã«é–¢æ•°ãŒé€ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§å®šç¾©ã•ã‚Œã‚‹é–¢æ•°ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚‰å†ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
åŒã˜é–¢æ•°ãŒ props ã§æ¸¡ã£ã¦ã„ã¦ã‚‚åˆ¥ã‚‚ã®ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ãŸã‚ã€ãƒ¡ãƒ¢åŒ–ãŒæ©Ÿèƒ½ã›ãšã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

ãã“ã§ `useCallback` ã®å‡ºç•ªã§ã™ã€‚

increment é–¢æ•°ã‚’ useCallback ã§ wrap ã—ã¾ã—ã‚‡ã†ã€‚

```js:App.jsx
  // ã“ã‚Œã‚’
  const incrementA = () => setCountA(prev => prev + 1)
  const incrementB = () => setCountB(prev => prev + 1)
  const incrementC = () => setCountC(prev => prev + 1)

  // ã“ã†ã™ã‚‹
  const incrementA = useCallback(
    () => setCountA(prev => prev + 1),
    [],
  )
  const incrementB = useCallback(
    () => setCountB(prev => prev + 1),
    [],
  )
  const incrementC = useCallback(
    () => setCountC(prev => prev + 1),
    [],
  )
```

ã“ã‚Œã«ã‚ˆã£ã¦å€¤ãŒå¤‰åŒ–ã—ãŸ Counter ã®ã¿å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã¯ãšã§ã™ï¼

## è£œè¶³â‘ ï¼šuseMemoã¨useCallbackã®é–¢ä¿‚ã«ã¤ã„ã¦
useCallback ãŒ useMemo ã®ç³–è¡£æ§‹æ–‡ã§ã‚ã‚‹ã“ã¨ã‚’è£œè¶³ã—ã¾ã™ã€‚

```js
// ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯å…¨ãåŒã˜å‹•ä½œã«ãªã‚‹
useMemo(() => () => true, [])
useCallback(() => true, [])
```

é–¢æ•°ã®è¿”ã‚Šå€¤ã‚’æ‰±ã†ã®ãŒ useMemo ã§ã€é–¢æ•°ãã®ã‚‚ã®ã‚’æ‰±ã†ã®ãŒ useCallback ã§ã™ã€‚

## è£œè¶³â‘¡ï¼šReact.memoã«ãŠã‘ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹propsã®æ¯”è¼ƒã«ã¤ã„ã¦
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® React.memo ã® props ã®æ¯”è¼ƒã«ã¯æµ…ã„æ¯”è¼ƒï¼ˆshallow equalï¼‰ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

JS ã«ãŠã‘ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã¯å‚ç…§å‹ãªã®ã§ã€å€¤ãŒä¸€è‡´ã—ã¦ã„ã¦ã‚‚åˆ¥ç‰©ã¨åˆ¤æ–­ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

https://ja.reactjs.org/docs/react-api.html#reactmemo
>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ props ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®è¤‡é›‘ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æµ…ã„æ¯”è¼ƒã®ã¿ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

â€»æµ…ã„æ¯”è¼ƒã¯ãŠãã‚‰ã `Object.is` ã®ã“ã¨ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚
https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/is

```js
var foo = { a: 1 };
var bar = { a: 1 };
Object.is(foo, foo);         // true
Object.is(foo, bar);         // false
```

â€»ã“ã“ãŒãƒ”ãƒ³ã¨æ¥ãªã„äººã¯ JS ã®å‹ã«ã¤ã„ã¦è¦å¾©ç¿’ã€‚

https://infoteck-life.com/a0074-js-variable-basic-address/

ã¤ã¾ã‚Šã€å…¨ãåŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã ã£ãŸã¨ã—ã¦ã‚‚ã€å†ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã§ã‚ã‚Œã°ã€ React ã¯åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ã¨åˆ¤æ–­ã—å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒèµ°ã£ã¦ã—ã¾ã†ã®ã§ã™ã€‚

### å¯¾ç­–â‘ 
 `useMemo` ã§ props ã«æ¸¡ã™ Object ã‚’ãƒ¡ãƒ¢åŒ–ã™ã‚‹ã“ã¨ã§ã¨ã‚Šã‚ãˆãšè§£æ±ºã—ã¾ã™ã€‚


### å¯¾ç­–â‘¡
props ã«æ¸¡ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ immutableï¼ˆä¸å¤‰ï¼‰ã«ã™ã‚‹ã“ã¨ã§ã‚‚ãŠãã‚‰ãè§£æ±ºã§ãã¾ã™ã€‚

https://sbfl.net/blog/2018/09/25/javascript-immutable-programming/

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä¸å¤‰ã§ã‚ã‚Œã° props ã®æ–°æ—§æ¯”è¼ƒãŒåŒä¸€ã¨åˆ¤å®šã•ã‚Œã¦å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’æŠ‘æ­¢ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚

ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã¯è‡ªåŠ›ã§ã‚‚ã‚ã‚‹ç¨‹åº¦å®Ÿè£…ã§ãã¾ã™ãŒã€ ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãŒã©ã†ã‹ãŒã¡ã‚‡ã£ã¨åˆ†ã‹ã‚Šã«ãã„ï¼†ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã«ãããªã‚‹ã®ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
æœ‰åã©ã“ã¯ Facebook é–‹ç™ºã® `immutable-js`ã€‚

https://immutable-js.com/

```ts
// åˆ©ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸
const { Map } = require('immutable');
const map1 = Map({ a: 1, b: 2, c: 3 });
const map2 = map1.set('b', 50);
map1.get('b') + ' vs. ' + map2.get('b'); // 2 vs. 50
```

### å¯¾ç­–â‘¢
ã‚‚ã† 1 ã¤ã®å¯¾ç­–ã¯ React.memo ã®ç¬¬ 2 å¼•æ•°ã§ deep equal ã§æ¯”è¼ƒã™ã‚‹ã“ã¨ã€‚

å‚ç…§æ¯”è¼ƒã¨æ¯”ã¹ã¦å‡¦ç†æ™‚é–“ãŒé•·ããªã‚‹å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚

æ¥­ç•Œæœ€é€Ÿã‚’è¬³ã† fast-deep-equal ã«æœŸå¾…ã—ãŸã„ã§ã™ã­ã€‚

https://github.com/epoberezkin/fast-deep-equal

```jsx
import equal from 'fast-deep-equal'
// deep-equalã§æ¯”è¼ƒã—ãŸçµæœç­‰ã—ã‘ã‚Œã°å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„
export default React.memo(Counter, (prev,next) => equal(prev,next)) 
```
